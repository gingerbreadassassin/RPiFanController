<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Google Charts!</title>

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <script type='text/javascript'>

    google.charts.load('current', {
        callback: function() {
            var firstrun = true;

            var d1 = new google.visualization.DataTable({
                cols: [{id: 'date_time', label: 'Date', type: 'datetime'},
                       {id: 'wtemp', label: 'Water Temp', type: 'number'},
                       {id: 'target', label: 'Target Temp', type: 'number'},
                       {id: 'indc', label: 'Intake Fan Speed %', type: 'number'}]
            });

            var options = {
                            hAxis: {
                              format: 'HH:mm' },
                            vAxis: {
                              title: 'Celsius / Percent',
                              baseline: 0,
                              viewWindow: {
                                  max: 100
                              }
                            }
                        };

            var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            chart.draw(d1, options);

            var d2 = new google.visualization.DataTable();

            var keys = [];
            for (var i = 0; i < d1.getNumberOfColumns(); i++) {
                keys.push([i, i]);
            }

            var t = Date.now() - 10800000;
            var dummy = new Date();
            var n = dummy.getTimezoneOffset() / 60;

            var dateFormat = new google.visualization.DateFormat({formatType: 'long', timeZone: -n});

            $.ajax({
                    url: 'getdata/'+(Date.now() - t).toString(),
                    type: 'GET',
                    dataType: 'json',
                    success: function (resp) {
                        d2 = new google.visualization.DataTable(resp);

                        for (var i = 0; i < d2.getNumberOfRows(); i++) {
                            var d = d2.getValue(i, 0);
                            d.setHours(d.getHours() - n);
                            d2.setValue(i, 0, d);
                        }

                        d1 = google.visualization.data.join(d1, d2, 'full', keys, [], []);
                        dateFormat.format(d1, 0);
                    }
            });

            t = Date.now();

            drawChart();

            setInterval(drawChart, 5000);

            function drawChart() {
                $.ajax({
                    url: 'getdata/'+(Date.now() - t).toString(),
                    type: 'GET',
                    dataType: 'json',
                    success: function (resp) {
                        d2 = new google.visualization.DataTable(resp);

                        for (var i = 0; i < d2.getNumberOfRows(); i++) {
                            var d = d2.getValue(i, 0);
                            d.setHours(d.getHours() - n);
                            d2.setValue(i, 0, d);
                        }

                        if (!firstrun) {
                            for (var x = 0; x < d2.getNumberOfRows(); x++) {
                                d1.removeRow(x);
                            }
                        }

                        else {
                            firstrun = false;
                        }

                        d1 = google.visualization.data.join(d1, d2, 'full', keys, [], []);
                        dateFormat.format(d1, 0);

                        chart.draw(d1, options);

                        t = Date.now();
                    }
                });
            }
        },
        packages: ['corechart']
    })

    </script>

    <script type="text/javascript">
        function update() {
            $.ajax({
                url: 'settings/',
                type: 'GET',
                dataType: 'json',
                success: function (resp) {
                    document.getElementById("bias").value = resp.bias;
                    document.getElementById("kp").value = resp.kp;
                    document.getElementById("ki").value  = resp.ki;
                    document.getElementById("kd").value  = resp.kd;
                    document.getElementById("target").value  = resp.target;
                    document.getElementById("use_pid").checked  = resp.use_pid;
                    document.getElementById("mandc").value  = resp.mandc;
                }
            });
        }

        function sub() {
            var data = {};
            data.bias = document.getElementById("bias").value;
            data.kp = document.getElementById("kp").value;
            data.ki = document.getElementById("ki").value;
            data.kd = document.getElementById("kd").value;
            data.target = document.getElementById("target").value;
            data.use_pid = document.getElementById("use_pid").checked;
            data.mandc = document.getElementById("mandc").value;
            $.ajax({
                url: 'settings/',
                type: 'POST',
                data: JSON.stringify(data),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function() {
                    alert('Settings applied successfully!')
                }
            });
        }

    </script>

    <!-- FONT
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <!-- CSS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="/static/css/normalize.css">
    <link rel="stylesheet" href="/static/css/skeleton.css">
    <!-- Favicon
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="/static/images/favicon.png">

</head>

<body>
<h1 style="position: absolute;left: 20px;top: 10px;">RPI Fan Controller</h1>
<div class="container">

</div>
<div id="chart_div"  style="width: 900px; height: 400px;position: absolute;left: 20px;top: 90px;"></div>
<div id="settings" style="position: absolute;width: 400px;height: 390px;top: 90px;left: 1100px;">
    <form style="display: table">
        <p style="display: table-row">
            <label for="bias" style="display: table-cell">Exhaust vs Intake:</label>
            <input type="number" name="bias" id="bias" style="display: table-cell">
        </p>
        <p style="display: table-row">
            <label for="kp" style="display: table-cell">PID P coefficient:</label>
            <input type="number" name="kp" id="kp" style="display: table-cell">
        </p>
        <p style="display: table-row">
            <label for="ki" style="display: table-cell">PID I coefficient:</label>
            <input type="number" name="ki" id="ki" style="display: table-cell">
        </p>
        <p style="display: table-row">
            <label for="kd" style="display: table-cell">PID D coefficient:</label>
            <input type="number" name="kd" id="kd" style="display: table-cell">
        </p>
        <p style="display: table-row">
            <label for="target" style="display: table-cell">Target Water Temp:</label>
            <input type="number" name="target" id="target" style="display: table-cell">
        </p>
        <p style="display: table-row">
            <label for="use_pid" style="display: table-cell">Automatic Fan Ctl:</label>
            <input type="checkbox" name="use_pid" id="use_pid" style="display: table-cell;position: relative;top: 5px;">
        </p>
        <p style="display: table-row">
            <label for="mandc" style="display: table-cell">Manual Fan Speed%:</label>
            <input type="range" name="mandc" id="mandc" min="20" max="100" step="5" style="display: table-cell;position: relative;top: 18px;">
        </p>
        <button type="button" onclick="update();" style="position: relative;top: 18px;left: 60px;">Update</button>
        <button type="button" onclick="sub();" style="position: relative;top: -30px;left: 210px;">Submit</button>
    </form>
</div>
</body>

</html>